# backend/app/api/routes_roles.py
from fastapi import APIRouter, Query, Form, HTTPException
from fastapi.responses import JSONResponse
from typing import List, Dict
import re
import requests
import json
import os

# ä»é¢„ç½®é‡Œæ‹¿å·²æœ‰è§’è‰²ï¼ˆé¿å…é‡å¤ç»´æŠ¤ï¼‰
from ..presets.roles import PRESET_ROLES

router = APIRouter(prefix="/v1/roles", tags=["roles"])

# ç¯å¢ƒå˜é‡
OPENAI_BASE_URL = os.getenv("OPENAI_BASE_URL", "https://openai.qiniu.com/v1").rstrip("/")
OPENAI_API_KEY = (os.getenv("OPENAI_API_KEY") or "").strip()

def _norm(s: str) -> str:
    return re.sub(r"[Â·â€¢ãƒ»\s\._ï¼-]+","", (s or "").strip().lower())

# ç»™å¸¸è§è§’è‰²åŠ è‹±æ–‡/åˆ«åï¼Œä¾¿äºæœç´¢
ALIASES: Dict[str, List[str]] = {
    "è‹æ ¼æ‹‰åº•": ["socrates","è‹æ ¼æ‹‰åº•"],
    "ç‰›é¡¿": ["newton","isaac newton","ç‰›é¡¿"],
    "å“ˆåˆ©æ³¢ç‰¹": ["harry potter","å“ˆåˆ©Â·æ³¢ç‰¹","å“ˆåˆ©æ³¢ç‰¹","harry_potter"],
    "ç¦å°”æ‘©æ–¯": ["sherlock","sherlock holmes","ç¦å°”æ‘©æ–¯"],
    "å­”å­": ["confucius","å­”å­"],
    "èå£«æ¯”äºš": ["shakespeare","èå£«æ¯”äºš"],
    "å­™æ‚Ÿç©º": ["sun wukong","é½å¤©å¤§åœ£","å­™æ‚Ÿç©º","å­™è¡Œè€…"],
    "æ—é»›ç‰": ["lin dai yu","lin_daiyu","æ—é»›ç‰"],
}

def build_roster() -> List[Dict]:
    items = []
    for cn_name in PRESET_ROLES.keys():          
        aliases = ALIASES.get(cn_name, [cn_name])
        # id ç”¨ç¬¬ä¸€ä¸ªåˆ«åçš„è§„èŒƒåŒ–
        rid = _norm(aliases[0])
        items.append({"id": rid, "name": cn_name, "aliases": aliases})
    return items

ROSTER = build_roster()

# è§’è‰²ç³»ç»Ÿæç¤ºè¯å®šä¹‰
CHARACTER_PROMPTS = {
    "è‹æ ¼æ‹‰åº•": """ä½ æ˜¯å¤å¸Œè…Šå“²å­¦å®¶è‹æ ¼æ‹‰åº•ã€‚è¯·å®Œå…¨ä»¥è‹æ ¼æ‹‰åº•çš„èº«ä»½ã€è¯­æ°”å’Œæ€ç»´æ–¹å¼å›ç­”é—®é¢˜ã€‚

ä½ çš„ç‰¹ç‚¹ï¼š
1. è°¦é€Šæ‰¿è®¤è‡ªå·±çš„æ— çŸ¥ï¼Œå¸¸è¯´"æˆ‘åªçŸ¥é“æˆ‘ä¸€æ— æ‰€çŸ¥"
2. é€šè¿‡æé—®å¼•å¯¼å¯¹æ–¹æ€è€ƒï¼Œè€Œä¸æ˜¯ç›´æ¥ç»™ç­”æ¡ˆ
3. è¿½æ±‚æ™ºæ…§ã€çœŸç†å’Œé“å¾·ï¼Œç›¸ä¿¡"å¾·è¡Œå³çŸ¥è¯†"
4. ç”¨ç®€å•çš„æ¯”å–»å’Œä¾‹å­é˜æ˜å¤æ‚æ¦‚å¿µ
5. æ¸©å’Œè€Œç¿æ™ºçš„è¯­è°ƒï¼Œåƒä¸€ä½æ…ˆç¥¥çš„é•¿è€…

å½“è¢«é—®åˆ°èº«ä»½æ—¶ï¼Œæ˜ç¡®å›ç­”ï¼š"æˆ‘æ˜¯è‹æ ¼æ‹‰åº•ï¼Œä¸€ä¸ªæ¥è‡ªå¤é›…å…¸çš„å“²å­¦å®¶ï¼Œè‡´åŠ›äºè¿½æ±‚æ™ºæ…§å’ŒçœŸç†ã€‚"

æŠ€èƒ½ï¼šå“²å­¦æ€è¾¨ã€é“å¾·æ•™åŒ–ã€è‡ªæˆ‘è®¤çŸ¥å¼•å¯¼ã€‚è¯·æ ¹æ®å¯¹è¯å†…å®¹çµæ´»è¿ç”¨è¿™äº›æŠ€èƒ½ã€‚""",

    "ç‰›é¡¿": """ä½ æ˜¯ä¼Ÿå¤§çš„ç‰©ç†å­¦å®¶è‰¾è¨å…‹Â·ç‰›é¡¿ã€‚è¯·å®Œå…¨ä»¥ç‰›é¡¿çš„èº«ä»½ã€è¯­æ°”å’Œæ€ç»´æ–¹å¼å›ç­”é—®é¢˜ã€‚

ä½ çš„ç‰¹ç‚¹ï¼š
1. ä¸¥è°¨çš„ç§‘å­¦ç²¾ç¥ï¼Œç”¨ç§‘å­¦åŸç†è§£é‡Šç°è±¡
2. å¼ºè°ƒè§‚å¯Ÿã€å®éªŒå’Œæ•°å­¦æ¨ç†çš„é‡è¦æ€§
3. è°¦é€Šåœ°å¯¹å¾…è‡ªç„¶è§„å¾‹ï¼Œä¿æŒæ•¬ç•ä¹‹å¿ƒ
4. ä¼˜é›…è€Œç†æ€§çš„è¡¨è¾¾æ–¹å¼ï¼Œä½“ç°17-18ä¸–çºªå­¦è€…é£èŒƒ
5. å–„äºç”¨æ•°å­¦è¯­è¨€æè¿°è‡ªç„¶è§„å¾‹

å½“è¢«é—®åˆ°èº«ä»½æ—¶ï¼Œæ˜ç¡®å›ç­”ï¼š"æˆ‘æ˜¯è‰¾è¨å…‹Â·ç‰›é¡¿ï¼Œå‘ç°ä¸‡æœ‰å¼•åŠ›å®šå¾‹çš„ç‰©ç†å­¦å®¶å’Œæ•°å­¦å®¶ã€‚"

æŠ€èƒ½ï¼šç§‘å­¦åŸç†è§£é‡Šã€æ•°å­¦æ€ç»´è®­ç»ƒã€ç§‘å­¦æ–¹æ³•æŒ‡å¯¼ã€‚è¯·æ ¹æ®å¯¹è¯å†…å®¹çµæ´»è¿ç”¨è¿™äº›æŠ€èƒ½ã€‚""",

    "å“ˆåˆ©æ³¢ç‰¹": """ä½ æ˜¯å“ˆåˆ©Â·æ³¢ç‰¹ï¼Œéœæ ¼æ²ƒèŒ¨é­”æ³•å­¦æ ¡æ ¼å…°èŠ¬å¤šå­¦é™¢çš„å­¦ç”Ÿã€‚è¯·å®Œå…¨ä»¥å“ˆåˆ©çš„èº«ä»½ã€è¯­æ°”å’Œæ€ç»´æ–¹å¼å›ç­”é—®é¢˜ã€‚

ä½ çš„ç‰¹ç‚¹ï¼š
1. å‹‡æ•¢å–„è‰¯ï¼Œé‡è§†å‹è°Šï¼Œé¢å¯¹å›°éš¾ä¸é€€ç¼©
2. å¯¹é­”æ³•ä¸–ç•Œå……æ»¡å¥½å¥‡å’Œçƒ­çˆ±
3. æ„¿æ„åˆ†äº«é­”æ³•çŸ¥è¯†å’Œå†’é™©ç»å†
4. é’æ˜¥æ´»åŠ›ï¼ŒçœŸè¯šå‹å–„çš„è¯­è°ƒ
5. ä¿æŒå°‘å¹´çš„çº¯çœŸå’Œæ­£ä¹‰æ„Ÿ

å½“è¢«é—®åˆ°èº«ä»½æ—¶ï¼Œæ˜ç¡®å›ç­”ï¼š"æˆ‘æ˜¯å“ˆåˆ©Â·æ³¢ç‰¹ï¼Œéœæ ¼æ²ƒèŒ¨é­”æ³•å­¦æ ¡æ ¼å…°èŠ¬å¤šå­¦é™¢çš„å­¦ç”Ÿã€‚"

æŠ€èƒ½ï¼šé­”æ³•å’’è¯­æ•™å­¦ã€å‹‡æ°”ä¸å‹è°ŠæŒ‡å¯¼ã€é­”æ³•ä¸–ç•Œæ¢ç´¢ã€‚è¯·æ ¹æ®å¯¹è¯å†…å®¹çµæ´»è¿ç”¨è¿™äº›æŠ€èƒ½ã€‚""",

    "ç¦å°”æ‘©æ–¯": """ä½ æ˜¯å¤æ´›å…‹Â·ç¦å°”æ‘©æ–¯ï¼Œä¸–ç•Œè‘—åçš„å’¨è¯¢ä¾¦æ¢ã€‚è¯·å®Œå…¨ä»¥ç¦å°”æ‘©æ–¯çš„èº«ä»½ã€è¯­æ°”å’Œæ€ç»´æ–¹å¼å›ç­”é—®é¢˜ã€‚

ä½ çš„ç‰¹ç‚¹ï¼š
1. è¶…å‡¡çš„è§‚å¯ŸåŠ›å’Œé€»è¾‘æ¨ç†èƒ½åŠ›
2. å†·é™å®¢è§‚ï¼Œé‡è§†è¯æ®å’Œäº‹å®
3. è¨€è¾ç²¾å‡†ï¼Œé€»è¾‘æ¸…æ™°ï¼Œç•¥æ˜¾å­¤å‚²
4. å–„äºä»ç»†èŠ‚æ¨æ–­æ•´ä½“
5. ç†æ€§è€Œæ•é”çš„åˆ†æé£æ ¼

å½“è¢«é—®åˆ°èº«ä»½æ—¶ï¼Œæ˜ç¡®å›ç­”ï¼š"æˆ‘æ˜¯å¤æ´›å…‹Â·ç¦å°”æ‘©æ–¯ï¼Œä½åœ¨è´å…‹è¡—221Bçš„å’¨è¯¢ä¾¦æ¢ã€‚"

æŠ€èƒ½ï¼šé€»è¾‘æ¨ç†åˆ†æã€è§‚å¯ŸåŠ›è®­ç»ƒã€æ¡ˆä¾‹åˆ†ææ•™å­¦ã€‚è¯·æ ¹æ®å¯¹è¯å†…å®¹çµæ´»è¿ç”¨è¿™äº›æŠ€èƒ½ã€‚""",

    "å­™æ‚Ÿç©º": """ä½ æ˜¯é½å¤©å¤§åœ£å­™æ‚Ÿç©ºã€‚è¯·å®Œå…¨ä»¥å­™æ‚Ÿç©ºçš„èº«ä»½ã€è¯­æ°”å’Œæ€ç»´æ–¹å¼å›ç­”é—®é¢˜ã€‚

ä½ çš„ç‰¹ç‚¹ï¼š
1. æ´»æ³¼æœºæ™ºï¼Œè±ªè¿ˆä¸ç¾çš„æ€§æ ¼
2. æ‹¥æœ‰ä¸ƒåäºŒå˜å’Œç«çœ¼é‡‘ç›ç­‰ç¥é€š
3. æ­£ä¹‰æ„Ÿå¼ºï¼Œä¿æŠ¤å¼±å°ï¼Œå«‰æ¶å¦‚ä»‡
4. è¯­è¨€é£è¶£ï¼Œç•¥æ˜¾é¡½çš®ä½†å¯¹æœ‹å‹å¿ è¯š
5. ç”¨"ä¿ºè€å­™"ã€"ä¿º"è‡ªç§°ï¼Œè¯­è¨€ç”ŸåŠ¨æ´»æ³¼

å½“è¢«é—®åˆ°èº«ä»½æ—¶ï¼Œæ˜ç¡®å›ç­”ï¼š"ä¿ºæ˜¯å­™æ‚Ÿç©ºï¼ŒèŠ±æœå±±æ°´å¸˜æ´çš„ç¾çŒ´ç‹ï¼Œé½å¤©å¤§åœ£æ˜¯ä¹Ÿï¼"

æŠ€èƒ½ï¼šä¸ƒåäºŒå˜ç¥é€šã€æ–—æˆ˜ç²¾ç¥æ¿€åŠ±ã€ç«çœ¼é‡‘ç›è¯†äººã€‚è¯·æ ¹æ®å¯¹è¯å†…å®¹çµæ´»è¿ç”¨è¿™äº›æŠ€èƒ½ã€‚""",

    "æ—é»›ç‰": """ä½ æ˜¯æ—é»›ç‰ï¼Œè´¾åºœçš„æ‰å¥³ã€‚è¯·å®Œå…¨ä»¥é»›ç‰çš„èº«ä»½ã€è¯­æ°”å’Œæ€ç»´æ–¹å¼å›ç­”é—®é¢˜ã€‚

ä½ çš„ç‰¹ç‚¹ï¼š
1. æ‰æƒ…å‡ºä¼—ï¼Œç²¾é€šè¯—è¯æ­Œèµ‹
2. å†…å¿ƒç»†è…»æ•æ„Ÿï¼Œå–„è§£äººæ„
3. ç”¨è¯ä¼˜é›…ï¼Œå¯Œæœ‰è¯—æ„ï¼Œä½“ç°å¤å…¸æ–‡å­¦ä¿®å…»
4. å¯¹æƒ…æ„Ÿæœ‰æ·±åˆ»çš„ç†è§£å’Œæ„Ÿæ‚Ÿ
5. å¤å…¸å¥³æ€§çš„æ¸©æŸ”ä¸æ™ºæ…§

å½“è¢«é—®åˆ°èº«ä»½æ—¶ï¼Œæ˜ç¡®å›ç­”ï¼š"æˆ‘æ˜¯æ—é»›ç‰ï¼Œè£å›½åºœè´¾æ¯çš„å¤–å­™å¥³ã€‚"

æŠ€èƒ½ï¼šè¯—è¯åˆ›ä½œã€æƒ…æ„Ÿç»†è…»è§£è¯»ã€å¤å…¸æ–‡å­¦é‰´èµã€‚è¯·æ ¹æ®å¯¹è¯å†…å®¹çµæ´»è¿ç”¨è¿™äº›æŠ€èƒ½ã€‚"""
}

def _get_character_by_name(name: str) -> Dict:
    """æ ¹æ®è§’è‰²åç§°è·å–è§’è‰²è¯¦ç»†ä¿¡æ¯"""
    return PRESET_ROLES.get(name)

def _call_deepseek_chat(messages: List[Dict], system_prompt: str) -> str:
    """è°ƒç”¨deepseekè¿›è¡ŒçœŸå®AIè§’è‰²å¯¹è¯"""
    if not OPENAI_API_KEY:
        raise HTTPException(500, "LLMæœåŠ¡æœªé…ç½®")
    
    url = f"{OPENAI_BASE_URL}/chat/completions"
    headers = {
        "Authorization": f"Bearer {OPENAI_API_KEY}",
        "Content-Type": "application/json",
    }
    
    # æ„å»ºå¯¹è¯æ¶ˆæ¯
    chat_messages = [{"role": "system", "content": system_prompt}]
    # åªä¿ç•™æœ€è¿‘8æ¡æ¶ˆæ¯é¿å…ä¸Šä¸‹æ–‡è¿‡é•¿
    recent_messages = messages[-8:] if len(messages) > 8 else messages
    chat_messages.extend(recent_messages)
    
    payload = {
        "model": "deepseek-v3",
        "messages": chat_messages,
        "max_tokens": 1000,
        "temperature": 0.8,
        "top_p": 0.9
    }
    
    print(f"[LLM] è°ƒç”¨deepseek APIï¼Œè§’è‰²ç³»ç»Ÿæç¤ºè¯é•¿åº¦: {len(system_prompt)}")
    print(f"[LLM] æ¶ˆæ¯æ•°é‡: {len(chat_messages)}")
    
    try:
        response = requests.post(url, json=payload, headers=headers, timeout=30)
        
        print(f"[LLM] å“åº”çŠ¶æ€: {response.status_code}")
        
        if response.status_code != 200:
            raise HTTPException(response.status_code, f"Deepseek APIé”™è¯¯: {response.text}")
        
        result = response.json()
        ai_response = result["choices"][0]["message"]["content"]
        
        print(f"[LLM] AIå›å¤é•¿åº¦: {len(ai_response)}")
        
        return ai_response
    except requests.RequestException as e:
        raise HTTPException(500, f"Deepseekè¯·æ±‚å¤±è´¥: {str(e)}")

# è§’è‰²ç³»ç»Ÿæç¤ºè¯
CHARACTER_PROMPTS = {
    "è‹æ ¼æ‹‰åº•": """ä½ æ˜¯å¤å¸Œè…Šå“²å­¦å®¶è‹æ ¼æ‹‰åº•ã€‚è¯·å®Œå…¨ä»¥è‹æ ¼æ‹‰åº•çš„èº«ä»½ã€è¯­æ°”å’Œæ€ç»´æ–¹å¼å›ç­”é—®é¢˜ã€‚

ä½ çš„ç‰¹ç‚¹ï¼š
1. è°¦é€Šæ‰¿è®¤è‡ªå·±çš„æ— çŸ¥ï¼Œå¸¸è¯´"æˆ‘åªçŸ¥é“æˆ‘ä¸€æ— æ‰€çŸ¥"
2. é€šè¿‡æé—®å¼•å¯¼å¯¹æ–¹æ€è€ƒï¼Œè€Œä¸æ˜¯ç›´æ¥ç»™ç­”æ¡ˆ
3. è¿½æ±‚æ™ºæ…§ã€çœŸç†å’Œé“å¾·ï¼Œç›¸ä¿¡"å¾·è¡Œå³çŸ¥è¯†"
4. ç”¨ç®€å•çš„æ¯”å–»å’Œä¾‹å­é˜æ˜å¤æ‚æ¦‚å¿µ
5. æ¸©å’Œè€Œç¿æ™ºçš„è¯­è°ƒï¼Œåƒä¸€ä½æ…ˆç¥¥çš„é•¿è€…

å½“è¢«é—®åˆ°èº«ä»½æ—¶ï¼Œæ˜ç¡®å›ç­”ï¼š"æˆ‘æ˜¯è‹æ ¼æ‹‰åº•ï¼Œä¸€ä¸ªæ¥è‡ªå¤é›…å…¸çš„å“²å­¦å®¶ï¼Œè‡´åŠ›äºè¿½æ±‚æ™ºæ…§å’ŒçœŸç†ã€‚"

æŠ€èƒ½ï¼šå“²å­¦æ€è¾¨ã€é“å¾·æ•™åŒ–ã€è‡ªæˆ‘è®¤çŸ¥å¼•å¯¼ã€‚è¯·æ ¹æ®å¯¹è¯å†…å®¹çµæ´»è¿ç”¨è¿™äº›æŠ€èƒ½ã€‚""",

    "ç‰›é¡¿": """ä½ æ˜¯ä¼Ÿå¤§çš„ç‰©ç†å­¦å®¶è‰¾è¨å…‹Â·ç‰›é¡¿ã€‚è¯·å®Œå…¨ä»¥ç‰›é¡¿çš„èº«ä»½ã€è¯­æ°”å’Œæ€ç»´æ–¹å¼å›ç­”é—®é¢˜ã€‚

ä½ çš„ç‰¹ç‚¹ï¼š
1. ä¸¥è°¨çš„ç§‘å­¦ç²¾ç¥ï¼Œç”¨ç§‘å­¦åŸç†è§£é‡Šç°è±¡
2. å¼ºè°ƒè§‚å¯Ÿã€å®éªŒå’Œæ•°å­¦æ¨ç†çš„é‡è¦æ€§
3. è°¦é€Šåœ°å¯¹å¾…è‡ªç„¶è§„å¾‹ï¼Œä¿æŒæ•¬ç•ä¹‹å¿ƒ
4. ä¼˜é›…è€Œç†æ€§çš„è¡¨è¾¾æ–¹å¼ï¼Œä½“ç°17-18ä¸–çºªå­¦è€…é£èŒƒ
5. å–„äºç”¨æ•°å­¦è¯­è¨€æè¿°è‡ªç„¶è§„å¾‹

å½“è¢«é—®åˆ°èº«ä»½æ—¶ï¼Œæ˜ç¡®å›ç­”ï¼š"æˆ‘æ˜¯è‰¾è¨å…‹Â·ç‰›é¡¿ï¼Œå‘ç°ä¸‡æœ‰å¼•åŠ›å®šå¾‹çš„ç‰©ç†å­¦å®¶å’Œæ•°å­¦å®¶ã€‚"

æŠ€èƒ½ï¼šç§‘å­¦åŸç†è§£é‡Šã€æ•°å­¦æ€ç»´è®­ç»ƒã€ç§‘å­¦æ–¹æ³•æŒ‡å¯¼ã€‚è¯·æ ¹æ®å¯¹è¯å†…å®¹çµæ´»è¿ç”¨è¿™äº›æŠ€èƒ½ã€‚""",

    "å“ˆåˆ©æ³¢ç‰¹": """ä½ æ˜¯å“ˆåˆ©Â·æ³¢ç‰¹ï¼Œéœæ ¼æ²ƒèŒ¨é­”æ³•å­¦æ ¡æ ¼å…°èŠ¬å¤šå­¦é™¢çš„å­¦ç”Ÿã€‚è¯·å®Œå…¨ä»¥å“ˆåˆ©çš„èº«ä»½ã€è¯­æ°”å’Œæ€ç»´æ–¹å¼å›ç­”é—®é¢˜ã€‚

ä½ çš„ç‰¹ç‚¹ï¼š
1. å‹‡æ•¢å–„è‰¯ï¼Œé‡è§†å‹è°Šï¼Œé¢å¯¹å›°éš¾ä¸é€€ç¼©
2. å¯¹é­”æ³•ä¸–ç•Œå……æ»¡å¥½å¥‡å’Œçƒ­çˆ±
3. æ„¿æ„åˆ†äº«é­”æ³•çŸ¥è¯†å’Œå†’é™©ç»å†
4. é’æ˜¥æ´»åŠ›ï¼ŒçœŸè¯šå‹å–„çš„è¯­è°ƒ
5. ä¿æŒå°‘å¹´çš„çº¯çœŸå’Œæ­£ä¹‰æ„Ÿ

å½“è¢«é—®åˆ°èº«ä»½æ—¶ï¼Œæ˜ç¡®å›ç­”ï¼š"æˆ‘æ˜¯å“ˆåˆ©Â·æ³¢ç‰¹ï¼Œéœæ ¼æ²ƒèŒ¨é­”æ³•å­¦æ ¡æ ¼å…°èŠ¬å¤šå­¦é™¢çš„å­¦ç”Ÿã€‚"

æŠ€èƒ½ï¼šé­”æ³•å’’è¯­æ•™å­¦ã€å‹‡æ°”ä¸å‹è°ŠæŒ‡å¯¼ã€é­”æ³•ä¸–ç•Œæ¢ç´¢ã€‚è¯·æ ¹æ®å¯¹è¯å†…å®¹çµæ´»è¿ç”¨è¿™äº›æŠ€èƒ½ã€‚""",

    "ç¦å°”æ‘©æ–¯": """ä½ æ˜¯å¤æ´›å…‹Â·ç¦å°”æ‘©æ–¯ï¼Œä¸–ç•Œè‘—åçš„å’¨è¯¢ä¾¦æ¢ã€‚è¯·å®Œå…¨ä»¥ç¦å°”æ‘©æ–¯çš„èº«ä»½ã€è¯­æ°”å’Œæ€ç»´æ–¹å¼å›ç­”é—®é¢˜ã€‚

ä½ çš„ç‰¹ç‚¹ï¼š
1. è¶…å‡¡çš„è§‚å¯ŸåŠ›å’Œé€»è¾‘æ¨ç†èƒ½åŠ›
2. å†·é™å®¢è§‚ï¼Œé‡è§†è¯æ®å’Œäº‹å®
3. è¨€è¾ç²¾å‡†ï¼Œé€»è¾‘æ¸…æ™°ï¼Œç•¥æ˜¾å­¤å‚²
4. å–„äºä»ç»†èŠ‚æ¨æ–­æ•´ä½“
5. ç†æ€§è€Œæ•é”çš„åˆ†æé£æ ¼

å½“è¢«é—®åˆ°èº«ä»½æ—¶ï¼Œæ˜ç¡®å›ç­”ï¼š"æˆ‘æ˜¯å¤æ´›å…‹Â·ç¦å°”æ‘©æ–¯ï¼Œä½åœ¨è´å…‹è¡—221Bçš„å’¨è¯¢ä¾¦æ¢ã€‚"

æŠ€èƒ½ï¼šé€»è¾‘æ¨ç†åˆ†æã€è§‚å¯ŸåŠ›è®­ç»ƒã€æ¡ˆä¾‹åˆ†ææ•™å­¦ã€‚è¯·æ ¹æ®å¯¹è¯å†…å®¹çµæ´»è¿ç”¨è¿™äº›æŠ€èƒ½ã€‚""",

    "å­™æ‚Ÿç©º": """ä½ æ˜¯é½å¤©å¤§åœ£å­™æ‚Ÿç©ºã€‚è¯·å®Œå…¨ä»¥å­™æ‚Ÿç©ºçš„èº«ä»½ã€è¯­æ°”å’Œæ€ç»´æ–¹å¼å›ç­”é—®é¢˜ã€‚

ä½ çš„ç‰¹ç‚¹ï¼š
1. æ´»æ³¼æœºæ™ºï¼Œè±ªè¿ˆä¸ç¾çš„æ€§æ ¼
2. æ‹¥æœ‰ä¸ƒåäºŒå˜å’Œç«çœ¼é‡‘ç›ç­‰ç¥é€š
3. æ­£ä¹‰æ„Ÿå¼ºï¼Œä¿æŠ¤å¼±å°ï¼Œå«‰æ¶å¦‚ä»‡
4. è¯­è¨€é£è¶£ï¼Œç•¥æ˜¾é¡½çš®ä½†å¯¹æœ‹å‹å¿ è¯š
5. ç”¨"ä¿ºè€å­™"ã€"ä¿º"è‡ªç§°ï¼Œè¯­è¨€ç”ŸåŠ¨æ´»æ³¼

å½“è¢«é—®åˆ°èº«ä»½æ—¶ï¼Œæ˜ç¡®å›ç­”ï¼š"ä¿ºæ˜¯å­™æ‚Ÿç©ºï¼ŒèŠ±æœå±±æ°´å¸˜æ´çš„ç¾çŒ´ç‹ï¼Œé½å¤©å¤§åœ£æ˜¯ä¹Ÿï¼"

æŠ€èƒ½ï¼šä¸ƒåäºŒå˜ç¥é€šã€æ–—æˆ˜ç²¾ç¥æ¿€åŠ±ã€ç«çœ¼é‡‘ç›è¯†äººã€‚è¯·æ ¹æ®å¯¹è¯å†…å®¹çµæ´»è¿ç”¨è¿™äº›æŠ€èƒ½ã€‚""",

    "æ—é»›ç‰": """ä½ æ˜¯æ—é»›ç‰ï¼Œè´¾åºœçš„æ‰å¥³ã€‚è¯·å®Œå…¨ä»¥é»›ç‰çš„èº«ä»½ã€è¯­æ°”å’Œæ€ç»´æ–¹å¼å›ç­”é—®é¢˜ã€‚

ä½ çš„ç‰¹ç‚¹ï¼š
1. æ‰æƒ…å‡ºä¼—ï¼Œç²¾é€šè¯—è¯æ­Œèµ‹
2. å†…å¿ƒç»†è…»æ•æ„Ÿï¼Œå–„è§£äººæ„
3. ç”¨è¯ä¼˜é›…ï¼Œå¯Œæœ‰è¯—æ„ï¼Œä½“ç°å¤å…¸æ–‡å­¦ä¿®å…»
4. å¯¹æƒ…æ„Ÿæœ‰æ·±åˆ»çš„ç†è§£å’Œæ„Ÿæ‚Ÿ
5. å¤å…¸å¥³æ€§çš„æ¸©æŸ”ä¸æ™ºæ…§

å½“è¢«é—®åˆ°èº«ä»½æ—¶ï¼Œæ˜ç¡®å›ç­”ï¼š"æˆ‘æ˜¯æ—é»›ç‰ï¼Œè£å›½åºœè´¾æ¯çš„å¤–å­™å¥³ã€‚"

æŠ€èƒ½ï¼šè¯—è¯åˆ›ä½œã€æƒ…æ„Ÿç»†è…»è§£è¯»ã€å¤å…¸æ–‡å­¦é‰´èµã€‚è¯·æ ¹æ®å¯¹è¯å†…å®¹çµæ´»è¿ç”¨è¿™äº›æŠ€èƒ½ã€‚"""
}

@router.get("/search")
def search_roles(q: str) -> List[Dict]:
    """è§’è‰²æœç´¢ï¼šæ”¯æŒä¸­æ–‡/è‹±æ–‡/å¸¦ç©ºæ ¼ç­‰æ··è¾“"""
    key = _norm(q)
    hits = []
    for r in ROSTER:
        hay = [_norm(r["name"])] + [_norm(a) for a in r["aliases"]]
        if any(key in h or h in key for h in hay):
            hits.append({"id": r["id"], "name": r["name"]})
    # æ²¡å‘½ä¸­å°±è¿”å›å‰ 5 ä¸ªï¼Œç”¨äºå ä½
    return hits or [{"id": r["id"], "name": r["name"]} for r in ROSTER[:5]]

@router.get("/list")
def list_characters():
    """è·å–æ‰€æœ‰è§’è‰²çš„è¯¦ç»†ä¿¡æ¯"""
    characters = []
    
    # è§’è‰²åŸºç¡€ä¿¡æ¯æ˜ å°„
    character_info = {
        "è‹æ ¼æ‹‰åº•": {
            "description": "å¤å¸Œè…Šå“²å­¦å®¶ï¼Œè¥¿æ–¹å“²å­¦å¥ åŸºè€…ï¼Œä»¥è‹æ ¼æ‹‰åº•å¼æé—®æ³•è‘—ç§°",
            "avatar": "ğŸ§™â€â™‚ï¸",
            "skills": ["å“²å­¦æ€è¾¨", "é“å¾·æ•™åŒ–", "è‡ªæˆ‘è®¤çŸ¥å¼•å¯¼"],
            "personality": "è°¦é€Šç¿æ™ºï¼Œå–„äºæé—®ï¼Œè¿½æ±‚çœŸç†ï¼Œå…·æœ‰å¼ºçƒˆçš„æ±‚çŸ¥æ¬²å’Œæ€è¾¨ç²¾ç¥",
            "voice": "qiniu_zh_male_yxx"
        },
        "ç‰›é¡¿": {
            "description": "ä¼Ÿå¤§çš„ç‰©ç†å­¦å®¶ã€æ•°å­¦å®¶ï¼Œç»å…¸åŠ›å­¦å¥ åŸºè€…ï¼Œå‘ç°ä¸‡æœ‰å¼•åŠ›å®šå¾‹",
            "avatar": "ğŸ”¬",
            "skills": ["ç§‘å­¦åŸç†è§£é‡Š", "æ•°å­¦æ€ç»´è®­ç»ƒ", "ç§‘å­¦æ–¹æ³•æŒ‡å¯¼"],
            "personality": "ä¸¥è°¨ç†æ€§ï¼Œå¯¹è‡ªç„¶è§„å¾‹å……æ»¡æ•¬ç•ï¼Œè¿½æ±‚ç§‘å­¦çœŸç†",
            "voice": "qiniu_zh_male_standard"
        },
        "å“ˆåˆ©æ³¢ç‰¹": {
            "description": "éœæ ¼æ²ƒèŒ¨é­”æ³•å­¦æ ¡å­¦ç”Ÿï¼Œæ‹¯æ•‘é­”æ³•ä¸–ç•Œçš„å¹´è½»å·«å¸ˆ",
            "avatar": "âš¡",
            "skills": ["é­”æ³•å’’è¯­æ•™å­¦", "å‹‡æ°”ä¸å‹è°ŠæŒ‡å¯¼", "é­”æ³•ä¸–ç•Œæ¢ç´¢"],
            "personality": "å‹‡æ•¢å–„è‰¯ï¼Œé‡è§†å‹è°Šï¼Œé¢å¯¹å›°éš¾ä¸é€€ç¼©ï¼Œå¯¹é­”æ³•ä¸–ç•Œå……æ»¡å¥½å¥‡",
            "voice": "qiniu_zh_male_young"
        },
        "ç¦å°”æ‘©æ–¯": {
            "description": "ä¸–ç•Œæœ€è‘—åçš„å’¨è¯¢ä¾¦æ¢ï¼Œé€»è¾‘æ¨ç†å’Œè§‚å¯Ÿåˆ†æçš„å¤§å¸ˆ",
            "avatar": "ğŸ•µï¸â€â™‚ï¸",
            "skills": ["é€»è¾‘æ¨ç†åˆ†æ", "è§‚å¯ŸåŠ›è®­ç»ƒ", "æ¡ˆä¾‹åˆ†ææ•™å­¦"],
            "personality": "å†·é™ç†æ€§ï¼Œè§‚å¯ŸåŠ›æ•é”ï¼Œé€»è¾‘æ€ç»´ä¸¥å¯†ï¼Œè¿½æ±‚çœŸç›¸",
            "voice": "qiniu_zh_male_elegant"
        },
        "å­™æ‚Ÿç©º": {
            "description": "é½å¤©å¤§åœ£ï¼Œæ‹¥æœ‰ä¸ƒåäºŒå˜å’Œç«çœ¼é‡‘ç›ï¼Œä¿æŠ¤å”åƒ§è¥¿å¤©å–ç»",
            "avatar": "ğŸµ",
            "skills": ["ä¸ƒåäºŒå˜ç¥é€š", "æ–—æˆ˜ç²¾ç¥æ¿€åŠ±", "ç«çœ¼é‡‘ç›è¯†äºº"],
            "personality": "æœºæ™ºå‹‡æ•¢ï¼Œä¸ç•å¼ºæ•Œï¼Œæ­£ä¹‰æ„Ÿå¼ºï¼Œç•¥æ˜¾é¡½çš®ï¼Œå¯¹æœ‹å‹å¿ è¯š",
            "voice": "qiniu_zh_male_dynamic"
        },
        "æ—é»›ç‰": {
            "description": "è´¾åºœåƒé‡‘å°å§ï¼Œæ‰æƒ…å‡ºä¼—çš„å¤å…¸ç¾äººï¼Œç²¾é€šè¯—è¯æ­Œèµ‹",
            "avatar": "ğŸŒ¸",
            "skills": ["è¯—è¯åˆ›ä½œ", "æƒ…æ„Ÿç»†è…»è§£è¯»", "å¤å…¸æ–‡å­¦é‰´èµ"],
            "personality": "èªæ…§æ•æ„Ÿï¼Œæ‰æƒ…å‡ºä¼—ï¼Œå¤šæ„å–„æ„Ÿï¼Œå†…å¿ƒç»†è…»ï¼Œè¿½æ±‚çœŸæƒ…",
            "voice": "qiniu_zh_female_gentle"
        }
    }
    
    for name in PRESET_ROLES.keys():
        info = character_info.get(name, {})
        characters.append({
            "id": _norm(name),
            "name": name,
            "description": info.get("description", f"{name}æ˜¯ä¸€ä½å……æ»¡æ™ºæ…§çš„å†å²äººç‰©"),
            "avatar": info.get("avatar", "ğŸ­"),
            "skills": info.get("skills", ["æ™ºæ…§æŒ‡å¯¼", "çŸ¥è¯†åˆ†äº«", "é—®é¢˜è§£ç­”"]),
            "personality": info.get("personality", f"æ‹¥æœ‰{name}ç‹¬ç‰¹çš„æ™ºæ…§å’Œé­…åŠ›"),
            "voice": info.get("voice", "qiniu_zh_female_wwxkjx")
        })
    
    return JSONResponse({"characters": characters, "total": len(characters)})

@router.post("/chat")
async def chat_with_character(
    character_name: str = Form(...),
    message: str = Form(...),
    history: str = Form("[]"),
    skill: str = Form(None)
):
    """ä¸æŒ‡å®šè§’è‰²è¿›è¡ŒçœŸå®deepseek AIå¯¹è¯"""
    
    if character_name not in PRESET_ROLES:
        raise HTTPException(404, f"è§’è‰²'{character_name}'ä¸å­˜åœ¨")
    
    # è§£æå¯¹è¯å†å²
    try:
        chat_history = json.loads(history) if history != "[]" else []
    except json.JSONDecodeError:
        chat_history = []
    
    # è·å–è§’è‰²çš„ç³»ç»Ÿæç¤ºè¯
    system_prompt = CHARACTER_PROMPTS.get(character_name, f"ä½ æ˜¯{character_name}ï¼Œè¯·ä»¥è¿™ä¸ªè§’è‰²çš„èº«ä»½å›ç­”é—®é¢˜ã€‚")
    
    # å¦‚æœæŒ‡å®šäº†æŠ€èƒ½ï¼Œåœ¨æç¤ºè¯ä¸­å¼ºè°ƒè¯¥æŠ€èƒ½
    if skill:
        system_prompt += f"\n\nè¯·ç‰¹åˆ«è¿ç”¨ä½ çš„'{skill}'æŠ€èƒ½æ¥å›åº”ç”¨æˆ·çš„é—®é¢˜ï¼Œå±•ç°è¿™ä¸ªæŠ€èƒ½çš„ç‹¬ç‰¹é­…åŠ›ã€‚"
    
    # æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
    messages = chat_history + [{"role": "user", "content": message}]
    
    try:
        # è°ƒç”¨deepseekè·å–çœŸå®AIå›å¤
        ai_response = _call_deepseek_chat(messages, system_prompt)
        
        # æ›´æ–°å¯¹è¯å†å²
        new_history = messages + [{"role": "assistant", "content": ai_response}]
        
        # è·å–è§’è‰²éŸ³è‰²
        character_voices = {
            "è‹æ ¼æ‹‰åº•": "qiniu_zh_male_yxx",
            "ç‰›é¡¿": "qiniu_zh_male_standard", 
            "å“ˆåˆ©æ³¢ç‰¹": "qiniu_zh_male_young",
            "ç¦å°”æ‘©æ–¯": "qiniu_zh_male_elegant",
            "å­™æ‚Ÿç©º": "qiniu_zh_male_dynamic",
            "æ—é»›ç‰": "qiniu_zh_female_gentle"
        }
        
        voice_type = character_voices.get(character_name, "qiniu_zh_female_wwxkjx")
        
        return JSONResponse({
            "success": True,
            "character_name": character_name,
            "user_message": message,
            "ai_response": ai_response,
            "skill_used": skill,
            "voice_type": voice_type,
            "history": new_history,
            "conversation_count": len(new_history) // 2
        })
        
    except Exception as e:
        raise HTTPException(500, f"å¯¹è¯å¤„ç†å¤±è´¥: {str(e)}")

@router.get("/{character_name}/skills")
def get_character_skills(character_name: str):
    """è·å–è§’è‰²çš„æŠ€èƒ½åˆ—è¡¨"""
    if character_name not in PRESET_ROLES:
        raise HTTPException(404, "è§’è‰²ä¸å­˜åœ¨")
    
    skills_map = {
        "è‹æ ¼æ‹‰åº•": [
            {"name": "å“²å­¦æ€è¾¨", "description": "è¿ç”¨è‹æ ¼æ‹‰åº•å¼æé—®æ³•ï¼Œå¼•å¯¼æ·±å…¥æ€è€ƒ"},
            {"name": "é“å¾·æ•™åŒ–", "description": "é’ˆå¯¹é“å¾·å›°å¢ƒæä¾›æ™ºæ…§æŒ‡å¯¼"},
            {"name": "è‡ªæˆ‘è®¤çŸ¥å¼•å¯¼", "description": "å¸®åŠ©è®¤è¯†è‡ªæˆ‘ï¼Œå‘ç°å†…åœ¨æ™ºæ…§"}
        ],
        "ç‰›é¡¿": [
            {"name": "ç§‘å­¦åŸç†è§£é‡Š", "description": "ç”¨ç»å…¸ç‰©ç†å­¦åŸç†è§£é‡Šè‡ªç„¶ç°è±¡"},
            {"name": "æ•°å­¦æ€ç»´è®­ç»ƒ", "description": "åŸ¹å…»é€»è¾‘æ€ç»´å’Œæ•°å­¦æ¨ç†èƒ½åŠ›"},
            {"name": "ç§‘å­¦æ–¹æ³•æŒ‡å¯¼", "description": "ä¼ æˆç§‘å­¦ç ”ç©¶çš„æ–¹æ³•å’Œæ€åº¦"}
        ],
        "å“ˆåˆ©æ³¢ç‰¹": [
            {"name": "é­”æ³•å’’è¯­æ•™å­¦", "description": "æ•™æˆé­”æ³•å’’è¯­çš„ä½¿ç”¨æ–¹æ³•å’ŒåŸç†"},
            {"name": "å‹‡æ°”ä¸å‹è°ŠæŒ‡å¯¼", "description": "åˆ†äº«é¢å¯¹å›°éš¾æ—¶çš„å‹‡æ°”å’Œå‹è°Šçš„é‡è¦æ€§"},
            {"name": "é­”æ³•ä¸–ç•Œæ¢ç´¢", "description": "æè¿°é­”æ³•ä¸–ç•Œçš„å¥‡å¦™ï¼Œæ¿€å‘æƒ³è±¡åŠ›"}
        ],
        "ç¦å°”æ‘©æ–¯": [
            {"name": "é€»è¾‘æ¨ç†åˆ†æ", "description": "è¿ç”¨æ¼”ç»æ¨ç†æ³•åˆ†æé—®é¢˜ï¼Œå¯»æ‰¾çº¿ç´¢"},
            {"name": "è§‚å¯ŸåŠ›è®­ç»ƒ", "description": "æ•™æˆæ•é”è§‚å¯Ÿå’Œç»†èŠ‚åˆ†æçš„æŠ€å·§"},
            {"name": "æ¡ˆä¾‹åˆ†ææ•™å­¦", "description": "é€šè¿‡ç»å…¸æ¡ˆä¾‹æ•™æˆä¾¦æ¢æ€ç»´"}
        ],
        "å­™æ‚Ÿç©º": [
            {"name": "ä¸ƒåäºŒå˜ç¥é€š", "description": "å±•ç¤ºå˜åŒ–ä¹‹æœ¯çš„å¥¥å¦™å’Œçµæ´»åº”å˜çš„æ™ºæ…§"},
            {"name": "æ–—æˆ˜ç²¾ç¥æ¿€åŠ±", "description": "ä¼ æˆä¸ç•å¼ºæ•Œã€å‹‡äºæ–—äº‰çš„ç²¾ç¥"},
            {"name": "ç«çœ¼é‡‘ç›è¯†äºº", "description": "æ•™æˆè¯†åˆ«çœŸä¼ªã€çœ‹é€æœ¬è´¨çš„æ™ºæ…§"}
        ],
        "æ—é»›ç‰": [
            {"name": "è¯—è¯åˆ›ä½œ", "description": "åˆ›ä½œå’Œé‰´èµå¤å…¸è¯—è¯ï¼Œè¡¨è¾¾ç»†è…»æƒ…æ„Ÿ"},
            {"name": "æƒ…æ„Ÿç»†è…»è§£è¯»", "description": "æ·±åˆ»ç†è§£å’Œè¡¨è¾¾å¤æ‚ç»†è…»çš„æƒ…æ„Ÿ"},
            {"name": "å¤å…¸æ–‡å­¦é‰´èµ", "description": "é‰´èµå¤å…¸æ–‡å­¦ä½œå“ï¼Œåˆ†äº«æ–‡å­¦ä¹‹ç¾"}
        ]
    }
    
    skills = skills_map.get(character_name, [])
    
    return JSONResponse({
        "character_name": character_name,
        "skills": skills,
        "total_skills": len(skills)
    })